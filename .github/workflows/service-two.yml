name: Build & Run Service-Two

on:
    workflow_call:
        outputs:
            service-url:
                description: "Service-Two URL"
                value: ${{ jobs.build-and-run.outputs.service-url }}

jobs:
    build-and-run:
        name: Build and Start Service-Two
        runs-on: ubuntu-latest
        outputs:
            service-url: ${{ steps.set-output.outputs.service-url }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "9.0.x"

            - name: Restore dependencies
              run: dotnet restore src/Service-Two/Service-Two.csproj

            - name: Build Service-Two
              run: dotnet build src/Service-Two/Service-Two.csproj --no-restore --configuration Release

            - name: Start Service-Two in background
              run: |
                  dotnet run --project src/Service-Two/Service-Two.csproj --no-build --configuration Release &
                  echo $! > service-two.pid
              env:
                  ASPNETCORE_URLS: http://localhost:5002

            - name: Wait for Service-Two to be ready
              run: |
                  timeout 60 bash -c 'until curl -f http://localhost:5002/swagger > /dev/null 2>&1; do sleep 2; done'
                  echo "Service-Two is ready at http://localhost:5002"

            - name: Set output
              id: set-output
              run: echo "service-url=http://localhost:5002" >> $GITHUB_OUTPUT

            - name: Save PID for cleanup
              run: echo "SERVICE_TWO_PID=$(cat service-two.pid)" >> $GITHUB_ENV
