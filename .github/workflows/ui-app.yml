name: Build & Run UI

on:
    workflow_call:
        outputs:
            app-url:
                description: "UI Application URL"
                value: ${{ jobs.build-and-run.outputs.app-url }}

jobs:
    build-and-run:
        name: Build and Start UI
        runs-on: ubuntu-latest
        outputs:
            app-url: ${{ steps.set-output.outputs.app-url }}

        defaults:
            run:
                working-directory: ./ui

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: "./ui/package-lock.json"

            - name: Install dependencies
              run: npm ci

            - name: Build UI
              run: npm run build

            - name: Start UI in background
              run: |
                  npm run start &
                  echo $! > ../ui.pid
              env:
                  PORT: 3000

            - name: Wait for UI to be ready
              run: |
                  timeout 60 bash -c 'until curl -f http://localhost:3000 > /dev/null 2>&1; do sleep 2; done'
                  echo "UI is ready at http://localhost:3000"

            - name: Set output
              id: set-output
              run: echo "app-url=http://localhost:3000" >> $GITHUB_OUTPUT

            - name: Save PID for cleanup
              run: echo "UI_PID=$(cat ../ui.pid)" >> $GITHUB_ENV
