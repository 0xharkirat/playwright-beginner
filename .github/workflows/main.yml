name: ðŸŽ­ E2E Test Pipeline

on:
    push:
        branches: [main]
   
    workflow_dispatch:

# Cancel in-progress runs for the same workflow and branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # ========================================
    # Stage 1: Build & Start Services (Parallel)
    # ========================================

    build-service-one:
        name: ðŸ”¨ Service-One
        uses: ./.github/workflows/service-one.yml

    build-service-two:
        name: ðŸ”¨ Service-Two
        uses: ./.github/workflows/service-two.yml

    build-ui:
        name: ðŸ”¨ UI
        uses: ./.github/workflows/ui-app.yml

    # ========================================
    # Stage 2: Run E2E Tests (After All Services Ready)
    # ========================================

    run-playwright-tests:
        name: ðŸŽ­ Playwright Tests
        needs: [build-service-one, build-service-two, build-ui]
        uses: ./.github/workflows/playwright.yml
        with:
            service-one-url: ${{ needs.build-service-one.outputs.service-url }}
            service-two-url: ${{ needs.build-service-two.outputs.service-url }}
            ui-url: ${{ needs.build-ui.outputs.app-url }}

    # ========================================
    # Stage 3: Summary
    # ========================================

    pipeline-complete:
        name: âœ… Pipeline Complete
        needs: [run-playwright-tests]
        runs-on: ubuntu-latest
        if: always()

        steps:
            - name: Check pipeline status
              run: |
                  if [ "${{ needs.run-playwright-tests.result }}" = "success" ]; then
                    echo "âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
                    echo "### Test Results Summary" >> $GITHUB_STEP_SUMMARY
                    echo "- Service-One: âœ… Running" >> $GITHUB_STEP_SUMMARY
                    echo "- Service-Two: âœ… Running" >> $GITHUB_STEP_SUMMARY
                    echo "- UI: âœ… Running" >> $GITHUB_STEP_SUMMARY
                    echo "- Playwright Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ Pipeline failed" >> $GITHUB_STEP_SUMMARY
                    exit 1
                  fi
