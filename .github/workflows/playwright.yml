name: Run Playwright Tests

on:
    workflow_call:
        inputs:
            service-one-url:
                required: true
                type: string
            service-two-url:
                required: true
                type: string
            ui-url:
                required: true
                type: string

jobs:
    test:
        name: Run E2E Tests with Coverage
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "9.0.x"

            - name: Restore test dependencies
              working-directory: ./tests/Playwright.Tests
              run: dotnet restore

            - name: Build test project
              working-directory: ./tests/Playwright.Tests
              run: dotnet build --no-restore --configuration Release

            - name: Install Playwright browsers
              working-directory: ./tests/Playwright.Tests
              run: pwsh bin/Release/net9.0/playwright.ps1 install --with-deps

            - name: Update appsettings.json with service URLs
              working-directory: ./tests/Playwright.Tests
              run: |
                  cat > appsettings.json << EOF
                  {
                    "PlaywrightSettings": {
                      "BaseUrl": "${{ inputs.ui-url }}",
                      "BrowserName": "chromium",
                      "Headless": true,
                      "SlowMo": 0,
                      "Timeout": 30000,
                      "Screenshot": "only-on-failure",
                      "Video": "retain-on-failure",
                      "Trace": "on-first-retry"
                    }
                  }
                  EOF

            - name: Run Playwright tests with coverage
              working-directory: ./tests/Playwright.Tests
              run: |
                  dotnet test \
                    --no-build \
                    --configuration Release \
                    --logger "trx;LogFileName=test-results.trx" \
                    --collect:"XPlat Code Coverage" \
                    --results-directory ./TestResults \
                    -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

            - name: Generate coverage report
              if: always()
              run: |
                  dotnet tool install -g dotnet-reportgenerator-globaltool
                  reportgenerator \
                    -reports:"tests/Playwright.Tests/TestResults/**/coverage.opencover.xml" \
                    -targetdir:"coverage-report" \
                    -reporttypes:"Html;MarkdownSummaryGithub" \
                    -verbosity:"Info"

            - name: Add coverage to PR comment
              if: always() && github.event_name == 'pull_request'
              run: |
                  if [ -f coverage-report/SummaryGithub.md ]; then
                    cat coverage-report/SummaryGithub.md >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-test-results
                  path: tests/Playwright.Tests/TestResults/
                  retention-days: 30

            - name: Upload coverage report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage-report/
                  retention-days: 30

            - name: Upload Playwright traces
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-traces
                  path: tests/Playwright.Tests/traces/
                  retention-days: 7

            - name: Publish test summary
              if: always()
              uses: dorny/test-reporter@v1
              with:
                  name: Playwright Test Results
                  path: tests/Playwright.Tests/TestResults/*.trx
                  reporter: dotnet-trx
                  fail-on-error: false
